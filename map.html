<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Navigation Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; }
    #map { height:60vh; width:100%; }
    #direction-panel,
    #hotspot-list { overflow-y:auto; }
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Nav Bar -->
  <nav class="bg-gray-800 p-4">
    <div class="container mx-auto">
      <h1 class="text-white text-xl font-bold">Navigation Pro</h1>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-4 relative">

    <!-- Controls -->
    <div id="controls" class="mb-4">
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">

        <!-- From -->
        <div>
          <input type="text" id="from"
                 class="w-full p-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="Starting location">
          <button class="w-full mt-2 p-2 border rounded hover:bg-gray-200"
                  onclick="startSpeechRecognition('from')">üé§</button>
        </div>

        <!-- To -->
        <div>
          <input type="text" id="to"
                 class="w-full p-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                 placeholder="Destination">
          <button class="w-full mt-2 p-2 border rounded hover:bg-gray-200"
                  onclick="startSpeechRecognition('to')">üé§</button>
        </div>

        <!-- Get Route -->
        <div>
          <button class="w-full p-2 bg-blue-600 text-white rounded shadow hover:bg-blue-700"
                  onclick="calculateRoute()">Get Route</button>
        </div>

        <!-- Hotspots -->
        <div>
          <select id="hotspot-type"
                  class="w-full p-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="hospital">Hospitals</option>
            <option value="restaurant">Restaurants</option>
            <option value="school">Schools</option>
            <option value="bank">Banks</option>
          </select>
          <button class="w-full mt-2 p-2 bg-gray-600 text-white rounded shadow hover:bg-gray-700"
                  onclick="findNearbyHotspots()">Find Nearby</button>
        </div>

      </div>
    </div>

    <!-- Home Button -->
    <button class="absolute top-5 left-5 p-3 bg-white rounded-full shadow hover:bg-gray-200"
            onclick="locateMe()">üè†</button>

    <!-- Map -->
    <div id="map" class="mb-4 rounded shadow"></div>

    <!-- Directions -->
    <div id="direction-panel"
         class="bg-white p-4 rounded shadow mb-4 h-20 border border-gray-200">
      Direction instructions will appear here...
    </div>

    <!-- Hotspot List -->
    <div id="hotspot-list"
         class="bg-white p-4 rounded shadow h-40 border border-gray-200">
      Nearby hotspots will appear here...
    </div>

  </div>

  <!-- Leaflet & Routing -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Globals
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    let map, marker, routeControl;
    let destinationCoords = null;
    let watchId = null;
    let hotspotMarkers = [];
    let currentLat, currentLng;

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Initialize on load
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    document.addEventListener('DOMContentLoaded', () => {
      locateMe();
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Ask for geolocation & set up map
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function locateMe() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported‚Äîusing default view.");
        setupMap(20, 77);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          currentLat = pos.coords.latitude;
          currentLng = pos.coords.longitude;
          setupMap(currentLat, currentLng);
        },
        err => {
          console.warn("Geolocation error:", err.message);
          alert("Could not get your location‚Äîusing default view.");
          setupMap(20, 77);
        },
        { enableHighAccuracy: true }
      );
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Build the Leaflet map & marker
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function setupMap(lat, lng) {
      // If map already exists, just recenter & move marker
      if (map) {
        map.setView([lat, lng], 13);
        marker.setLatLng([lat, lng]);
        reverseGeocode(lat, lng);
        return;
      }

      // 1) Create map
      map = L.map('map').setView([lat, lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // 2) Add draggable ‚Äúyou are here‚Äù marker
      marker = L.marker([lat, lng], { draggable: true })
        .addTo(map)
        .bindPopup("You are here")
        .openPopup();

      marker.on('dragend', () => {
        const p = marker.getLatLng();
        currentLat = p.lat; currentLng = p.lng;
        reverseGeocode(p.lat, p.lng);
        updateRouteAndDirections();
      });

      // 3) Reverse‚Äëgeocode initial
      reverseGeocode(lat, lng);

      // 4) Start watchPosition for live updates
      startWatchingPosition();
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Reverse Geocode via Nominatim
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function reverseGeocode(lat, lon) {
      const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
      fetch(url)
        .then(r => r.json())
        .then(data => {
          if (data.display_name) {
            document.getElementById('from').value = data.display_name;
          }
        })
        .catch(err => console.error("Reverse geocoding error:", err));
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Speech input for any field
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function startSpeechRecognition(inputId) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return alert("Speech recognition not supported.");
      const recog = new SR();
      recog.lang = 'en-US';
      recog.start();
      recog.onresult = evt => {
        document.getElementById(inputId).value = evt.results[0][0].transcript;
      };
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Calculate route ‚Äúfrom‚Äù marker ‚Üí ‚Äúto‚Äù address
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    async function calculateRoute() {
      const to = document.getElementById('to').value.trim();
      if (!marker) return alert("Location not ready.");
      if (!to)     return alert("Enter a destination.");

      try {
        // 1) Forward‚Äëgeocode ‚Äúto‚Äù
        const resp = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(to)}`
        );
        const places = await resp.json();
        if (!places.length) return alert("Destination not found.");

        const lat = +places[0].lat, lon = +places[0].lon;
        destinationCoords = [lat, lon];

        // 2) Remove old route
        if (routeControl) map.removeControl(routeControl);

        // 3) Add new route
        routeControl = L.Routing.control({
          waypoints: [
            L.latLng(currentLat, currentLng),
            L.latLng(lat, lon)
          ],
          routeWhileDragging: true,
          createMarker: (i, wp) => L.marker(wp.latLng, { draggable: false })
        }).addTo(map);

        routeControl.on('routesfound', e => {
          const s = e.routes[0].summary;
          const txt = `Route found. Distance: ${Math.round(s.totalDistance)}¬†m, ETA: ${Math.round(s.totalTime/60)}¬†min.`;
          document.getElementById('direction-panel').innerText = txt;
          speakText(txt);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Hotspot search via Overpass
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function findNearbyHotspots() {
      if (!marker) return alert("Please let us get your location first.");
      hotspotMarkers.forEach(m => map.removeLayer(m));
      hotspotMarkers = [];
      const listEl = document.getElementById('hotspot-list');
      listEl.innerHTML = "Searching‚Ä¶";

      const type = document.getElementById('hotspot-type').value;
      const q = `
        [out:json];
        (
          node["amenity"="${type}"](around:1000,${currentLat},${currentLng});
          way ["amenity"="${type}"](around:1000,${currentLat},${currentLng});
          relation["amenity"="${type}"](around:1000,${currentLat},${currentLng});
        );
        out center;
      `;
      fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => displayHotspots(data.elements))
        .catch(err => {
          console.error(err);
          listEl.innerHTML = "Error retrieving hotspots.";
        });
    }

    function displayHotspots(elements) {
      const listEl = document.getElementById('hotspot-list');
      const pts = elements.map(el => {
        const lat = el.lat||el.center?.lat, lon = el.lon||el.center?.lon;
        if (!lat||!lon) return null;
        return { name: el.tags?.name||"Unnamed", lat, lon };
      }).filter(Boolean);

      if (!pts.length) {
        listEl.innerHTML = "No nearby hotspots found.";
        return;
      }
      listEl.innerHTML = "<strong>Nearby Hotspots:</strong><br>";
      pts.forEach(p => {
        const m = L.marker([p.lat,p.lon]).addTo(map)
          .bindTooltip(p.name).bindPopup(p.name)
          .on('click', () => calculateRouteTo(p.lat,p.lon));
        hotspotMarkers.push(m);

        const div = document.createElement('div');
        div.className = "cursor-pointer py-1 border-b";
        div.innerText = p.name;
        div.onclick = () => calculateRouteTo(p.lat,p.lon);
        listEl.appendChild(div);
      });
    }

    function calculateRouteTo(lat, lon) {
      if (!marker) return;
      if (routeControl) map.removeControl(routeControl);
      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(currentLat, currentLng),
          L.latLng(lat, lon)
        ],
        routeWhileDragging: true,
        createMarker: (i, wp) => L.marker(wp.latLng, { draggable: false })
      }).addTo(map);

      routeControl.on('routesfound', e => {
        const s = e.routes[0].summary;
        const txt = `New route: ${Math.round(s.totalDistance)}¬†m, ETA: ${Math.round(s.totalTime/60)}¬†min.`;
        document.getElementById('direction-panel').innerText = txt;
        speakText(txt);
      });
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Live watchPosition for bearing updates
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function startWatchingPosition() {
      if (!navigator.geolocation) return;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = navigator.geolocation.watchPosition(pos => {
        currentLat = pos.coords.latitude;
        currentLng = pos.coords.longitude;
        marker.setLatLng([currentLat, currentLng]);

        if (destinationCoords) {
          const b = calculateBearing(currentLat, currentLng, ...destinationCoords);
          const dir = getDirectionFromBearing(b);
          const txt = `You are heading ${dir}.`;
          document.getElementById('direction-panel').innerText = txt;
          speakText(txt);
        }
      }, console.error, { enableHighAccuracy:true });
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const r = Math.PI/180;
      const y = Math.sin((lon2-lon1)*r)*Math.cos(lat2*r);
      const x = Math.cos(lat1*r)*Math.sin(lat2*r)
              - Math.sin(lat1*r)*Math.cos(lat2*r)*Math.cos((lon2-lon1)*r);
      return (Math.atan2(y,x)*(180/Math.PI)+360)%360;
    }

    function getDirectionFromBearing(b) {
      if (b<22.5||b>=337.5) return "North";
      if (b<67.5)             return "North-East";
      if (b<112.5)            return "East";
      if (b<157.5)            return "South-East";
      if (b<202.5)            return "South";
      if (b<247.5)            return "South-West";
      if (b<292.5)            return "West";
                              return "North-West";
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Voice output
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function speakText(txt) {
      if ('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance(txt);
        window.speechSynthesis.speak(u);
      }
    }
  </script>
</body>
</html>
